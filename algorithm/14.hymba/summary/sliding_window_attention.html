<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWA 및 Meta Token 동작 원리 시각화</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Source+Code+Pro:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .grid-cell {
            width: 1.5rem; height: 1.5rem;
            border: 1px solid #e5e7eb;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
         .axis-label {
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Source Code Pro', monospace;
            font-size: 0.75rem;
            color: #6b7280;
        }
        @media (max-width: 768px) {
            .grid-cell {
                width: 1rem; height: 1rem;
            }
            .axis-label {
                font-size: 0.6rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl w-full max-w-5xl">
        <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-2">SWA 및 Meta Token 동작 원리 시각화</h1>
        <p class="text-center text-gray-500 mb-8">슬라이더를 조작하여 2D 어텐션 마스크가 어떻게 구성되는지 확인해보세요.</p>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
            <div>
                <label for="seqLengthSlider" class="block text-sm font-medium text-gray-700">실제 시퀀스 길이 (N): <span id="seqLengthValue" class="font-bold text-blue-600">12</span></label>
                <input id="seqLengthSlider" type="range" min="4" max="24" step="1" value="12" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>
            <div>
                <label for="metaTokenSlider" class="block text-sm font-medium text-gray-700">메타 토큰 개수 (M): <span id="metaTokenValue" class="font-bold text-blue-600">4</span></label>
                <input id="metaTokenSlider" type="range" min="0" max="8" step="1" value="4" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>
            <div>
                <label for="windowSizeSlider" class="block text-sm font-medium text-gray-700">윈도우 크기 (W): <span id="windowSizeValue" class="font-bold text-blue-600">3</span></label>
                <input id="windowSizeSlider" type="range" min="1" max="16" step="1" value="3" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>
             <div>
                <label for="highlightRowSlider" class="block text-sm font-medium text-gray-700">강조할 행 (Query): <span id="highlightRowValue" class="font-bold text-blue-600">8</span></label>
                <input id="highlightRowSlider" type="range" min="1" max="16" step="1" value="8" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>
        </div>

        <div class="overflow-x-auto flex justify-center">
            <div class="flex">
                 <div class="flex flex-col items-center justify-center mr-2">
                     <span class="writing-mode-vertical-rl transform rotate-180 font-bold text-gray-600 text-sm">Query (행)</span>
                 </div>
                 <div class="flex flex-col">
                     <div class="flex justify-center items-center ml-8 mb-2">
                         <span class="font-bold text-gray-600 text-sm">Key (열)</span>
                     </div>
                    <div id="attentionGridContainer" class="inline-grid gap-1 p-2 bg-gray-50 rounded-lg border">
                        <!-- Grid will be generated by JS -->
                    </div>
                 </div>
            </div>
        </div>
        
        <div id="explanation" class="mt-6 text-center text-gray-700 bg-blue-50 p-4 rounded-lg border border-blue-200 min-h-[50px]">
            <!-- Explanation text will be generated by JS -->
        </div>

        <div class="mt-6 flex flex-wrap justify-center gap-x-6 gap-y-2 text-sm">
             <div class="flex items-center"><div class="w-4 h-4 bg-gray-200 mr-2 rounded"></div><span>계산 안함</span></div>
             <div class="flex items-center"><div class="w-4 h-4 bg-purple-500 mr-2 rounded"></div><span>메타 토큰 참조</span></div>
             <div class="flex items-center"><div class="w-4 h-4 bg-green-500 mr-2 rounded"></div><span>데이터 토큰 참조 (Window)</span></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const seqLengthSlider = document.getElementById('seqLengthSlider');
            const metaTokenSlider = document.getElementById('metaTokenSlider');
            const windowSizeSlider = document.getElementById('windowSizeSlider');
            const highlightRowSlider = document.getElementById('highlightRowSlider');
            
            const seqLengthValue = document.getElementById('seqLengthValue');
            const metaTokenValue = document.getElementById('metaTokenValue');
            const windowSizeValue = document.getElementById('windowSizeValue');
            const highlightRowValue = document.getElementById('highlightRowValue');
            
            const attentionGridContainer = document.getElementById('attentionGridContainer');
            const explanationDiv = document.getElementById('explanation');

            function drawGrid() {
                const seqLen = parseInt(seqLengthSlider.value);
                const nMeta = parseInt(metaTokenSlider.value);
                const windowSize = parseInt(windowSizeSlider.value);
                const totalSeqLen = seqLen + nMeta;
                let highlightRow = parseInt(highlightRowSlider.value);

                highlightRowSlider.max = totalSeqLen;
                if (highlightRow > totalSeqLen) {
                    highlightRow = totalSeqLen;
                    highlightRowSlider.value = totalSeqLen;
                }
                
                seqLengthValue.textContent = seqLen;
                metaTokenValue.textContent = nMeta;
                windowSizeValue.textContent = windowSize;
                highlightRowValue.textContent = highlightRow;

                attentionGridContainer.innerHTML = '';
                attentionGridContainer.style.gridTemplateColumns = `repeat(${totalSeqLen + 1}, auto)`;

                // Add column labels
                attentionGridContainer.appendChild(document.createElement('div')); // Top-left empty cell
                for (let j = 1; j <= totalSeqLen; j++) {
                    const label = document.createElement('div');
                    label.className = 'axis-label';
                    label.textContent = j;
                    attentionGridContainer.appendChild(label);
                }

                for (let i = 1; i <= totalSeqLen; i++) {
                    // Add row label
                    const rowLabel = document.createElement('div');
                    rowLabel.className = 'axis-label';
                    rowLabel.textContent = i;
                    attentionGridContainer.appendChild(rowLabel);

                    for (let j = 1; j <= totalSeqLen; j++) {
                        const cell = document.createElement('div');
                        cell.classList.add('grid-cell');
                        
                        const row = i; // Query position (1-based)
                        const col = j; // Key position (1-based)

                        let color = '#f1f5f9'; // gray-100 (default: masked)
                        
                        // Causal mask: cannot attend to future
                        if (col <= row) {
                           if (row <= nMeta) { // Query is a meta token
                               color = '#a855f7'; // purple
                           } else { // Query is a data token
                               // Rule 1: Always attend to all meta tokens
                               if (col <= nMeta) {
                                   color = '#a855f7'; // purple
                               } 
                               // Rule 2: Attend to data tokens within the sliding window
                               else {
                                   if (row - col < windowSize) {
                                       color = '#22c55e'; // green
                                   }
                               }
                           }
                        }

                        cell.style.backgroundColor = color;
                        if(row === highlightRow) {
                            cell.style.borderColor = '#3b82f6';
                            cell.style.borderWidth = '2px';
                        }
                        
                        attentionGridContainer.appendChild(cell);
                    }
                }

                // Update explanation text
                let explanation = `현재 <strong>${highlightRow}번째</strong> 행(Query)을 강조하고 있습니다.`;
                if (highlightRow <= nMeta) {
                    explanation += ` 이 토큰은 메타 토큰이므로, 자신을 포함한 이전의 모든 메타 토큰(보라색)을 참조합니다.`;
                } else {
                    const windowStart = Math.max(nMeta + 1, highlightRow - windowSize + 1);
                    explanation += ` 이 토큰은 데이터 토큰이므로, 모든 메타 토큰(보라색)과 윈도우 내의 데이터 토큰(${windowStart} ~ ${highlightRow}번째, 녹색)들을 참조합니다.`;
                }
                explanationDiv.innerHTML = explanation;
            }

            seqLengthSlider.addEventListener('input', drawGrid);
            metaTokenSlider.addEventListener('input', drawGrid);
            windowSizeSlider.addEventListener('input', drawGrid);
            highlightRowSlider.addEventListener('input', drawGrid);

            drawGrid();
        });
    </script>
</body>
</html>
